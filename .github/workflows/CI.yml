name: Terraform + K3s CI

on:
  push:
    branches: [ "main", "testing" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenTofu
        run: |
          curl -fsSL https://get.opentofu.org/install.sh | bash
          tofu version

      - name: Install kubectl & K3d (for local K3s)
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d cluster create local-cluster --wait
          kubectl cluster-info

      - name: Setup KUBECONFIG
        run: |
          mkdir -p ~/.kube
          k3d kubeconfig get local-cluster > ~/.kube/config

      - name: Terraform Init & Apply
        working-directory: ./dev/excute
        run: |
          tofu init
          tofu apply -auto-approve -var-file=../devde/main.tfvars

      - name: Verify Deployment
        run: |
          kubectl get ns
          kubectl get pods -A
